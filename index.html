<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Strategy Backtester - TradingView Style</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="styles.css">
  <script src="https://cdn.jsdelivr.net/npm/monaco-editor@0.45.0/min/vs/loader.js"></script>
</head>

<body>
  <div class="app-container">
    <!-- Header -->
    <header class="header">
      <div class="header-left">
        <div class="logo">
          <svg viewBox="0 0 24 24" fill="currentColor">
            <path d="M16 6l2.29 2.29-4.88 4.88-4-4L2 16.59 3.41 18l6-6 4 4 6.3-6.29L22 12V6z" />
          </svg>
          Strategy Tester
        </div>

        <div class="dropdown">
          <div class="symbol-selector" id="symbolSelector" role="button" tabindex="0">
            <span class="symbol-name" id="symbolName">ETH/USDT</span>
            <span class="symbol-price" id="symbolPrice">Loading...</span>
            <span class="symbol-change" id="symbolChange">+0.00%</span>
            <svg width="12" height="12" viewBox="0 0 12 12" fill="currentColor">
              <path d="M2.5 4.5L6 8L9.5 4.5" stroke="currentColor" stroke-width="1.5" fill="none" />
            </svg>
          </div>
          <div class="dropdown-menu" id="symbolDropdown">
            <div class="dropdown-item active" data-symbol="ETHUSDT" role="button" tabindex="0">ETH/USDT</div>
            <div class="dropdown-item" data-symbol="BTCUSDT" role="button" tabindex="0">BTC/USDT</div>
            <div class="dropdown-item" data-symbol="SOLUSDT" role="button" tabindex="0">SOL/USDT</div>
            <div class="dropdown-item" data-symbol="BNBUSDT" role="button" tabindex="0">BNB/USDT</div>
            <div class="dropdown-item" data-symbol="XRPUSDT" role="button" tabindex="0">XRP/USDT</div>
            <div class="dropdown-item" data-symbol="ADAUSDT" role="button" tabindex="0">ADA/USDT</div>
            <div class="dropdown-item" data-symbol="DOGEUSDT" role="button" tabindex="0">DOGE/USDT</div>
            <div class="dropdown-item" data-symbol="AVAXUSDT" role="button" tabindex="0">AVAX/USDT</div>
            <div class="dropdown-divider"></div>
            <div class="dropdown-header">Stocks</div>
            <div class="dropdown-item" data-symbol="AAPL" role="button" tabindex="0">AAPL (Apple)</div>
            <div class="dropdown-item" data-symbol="GOOGL" role="button" tabindex="0">GOOGL (Google)</div>
            <div class="dropdown-item" data-symbol="MSFT" role="button" tabindex="0">MSFT (Microsoft)</div>
            <div class="dropdown-item" data-symbol="TSLA" role="button" tabindex="0">TSLA (Tesla)</div>
            <div class="dropdown-divider"></div>
            <div class="dropdown-header">Forex</div>
            <div class="dropdown-item" data-symbol="EURUSD" role="button" tabindex="0">EUR/USD</div>
            <div class="dropdown-item" data-symbol="GBPUSD" role="button" tabindex="0">GBP/USD</div>
            <div class="dropdown-item" data-symbol="USDJPY" role="button" tabindex="0">USD/JPY</div>
          </div>
        </div>

        <div class="timeframe-tabs" id="timeframeTabs">
          <button class="timeframe-tab" data-interval="15m">15m</button>
          <button class="timeframe-tab" data-interval="1h">1H</button>
          <button class="timeframe-tab" data-interval="4h">4H</button>
          <button class="timeframe-tab active" data-interval="1d">1D</button>
          <button class="timeframe-tab" data-interval="1w">1W</button>
        </div>
      </div>

      <div class="header-right">
        <button class="btn btn-secondary" id="togglePanel">
          <svg viewBox="0 0 24 24" fill="currentColor">
            <path d="M3 13h2v-2H3v2zm0 4h2v-2H3v2zm0-8h2V7H3v2zm4 4h14v-2H7v2zm0 4h14v-2H7v2zM7 7v2h14V7H7z" />
          </svg>
          Strategy Panel
        </button>
        <button class="theme-toggle" id="themeToggle" title="Toggle theme">
          <svg id="moonIcon" viewBox="0 0 24 24" fill="currentColor">
            <path
              d="M12 3c-4.97 0-9 4.03-9 9s4.03 9 9 9 9-4.03 9-9c0-.46-.04-.92-.1-1.36-.98 1.37-2.58 2.26-4.4 2.26-2.98 0-5.4-2.42-5.4-5.4 0-1.81.89-3.42 2.26-4.4-.44-.06-.9-.1-1.36-.1z" />
          </svg>
          <svg id="sunIcon" viewBox="0 0 24 24" fill="currentColor">
            <path
              d="M12 7c-2.76 0-5 2.24-5 5s2.24 5 5 5 5-2.24 5-5-2.24-5-5-5zM2 13h2c.55 0 1-.45 1-1s-.45-1-1-1H2c-.55 0-1 .45-1 1s.45 1 1 1zm18 0h2c.55 0 1-.45 1-1s-.45-1-1-1h-2c-.55 0-1 .45-1 1s.45 1 1 1zM11 2v2c0 .55.45 1 1 1s1-.45 1-1V2c0-.55-.45-1-1-1s-1 .45-1 1zm0 18v2c0 .55.45 1 1 1s1-.45 1-1v-2c0-.55-.45-1-1-1s-1 .45-1 1z" />
          </svg>
        </button>
      </div>
    </header>

    <!-- Main Content -->
    <div class="main-content">
      <!-- Toolbar -->
      <div class="toolbar">
        <button class="tool-btn active" id="crosshairTool" title="Crosshair">
          <svg viewBox="0 0 24 24" fill="currentColor">
            <path
              d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 17.93c3.95-.49 7-3.85 7-7.93 0-.62-.08-1.21-.21-1.79L15 15v1c0 1.1-.9 2-2 2v1.93z" />
          </svg>
        </button>

        <button class="tool-btn" id="zoomInTool" title="Zoom In">
          <svg viewBox="0 0 24 24" fill="currentColor">
            <path
              d="M15.5 14h-.79l-.28-.27C15.41 12.59 16 11.11 16 9.5 16 5.91 13.09 3 9.5 3S3 5.91 3 9.5 5.91 16 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14zm.5-7H9v2H7v1h2v2h1v-2h2V9h-2z" />
          </svg>
        </button>

        <button class="tool-btn" id="zoomOutTool" title="Zoom Out">
          <svg viewBox="0 0 24 24" fill="currentColor">
            <path
              d="M15.5 14h-.79l-.28-.27C15.41 12.59 16 11.11 16 9.5 16 5.91 13.09 3 9.5 3S3 5.91 3 9.5 5.91 16 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14zM7 9h5v1H7z" />
          </svg>
        </button>

        <button class="tool-btn" id="fitTool" title="Fit Content">
          <svg viewBox="0 0 24 24" fill="currentColor">
            <path
              d="M3 5v4h2V5h4V3H5c-1.1 0-2 .9-2 2zm2 10H3v4c0 1.1.9 2 2 2h4v-2H5v-4zm14 4h-4v2h4c1.1 0 2-.9 2-2v-4h-2v4zm0-16h-4v2h4v4h2V5c0-1.1-.9-2-2-2z" />
          </svg>
        </button>

        <div class="tool-separator"></div>

        <button class="tool-btn" id="clearTradesBtn" title="Clear trade markers">
          <svg viewBox="0 0 24 24" fill="currentColor">
            <path
              d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z" />
          </svg>
        </button>
      </div>

      <!-- Chart Area -->
      <div class="chart-area">
        <div class="chart-wrapper">
          <div class="chart-container">
            <div class="ohlc-panel">
              <div class="ohlc-item">
                <span class="ohlc-label">O</span>
                <span class="ohlc-value" id="ohlcOpen">-</span>
              </div>
              <div class="ohlc-item">
                <span class="ohlc-label">H</span>
                <span class="ohlc-value" id="ohlcHigh">-</span>
              </div>
              <div class="ohlc-item">
                <span class="ohlc-label">L</span>
                <span class="ohlc-value" id="ohlcLow">-</span>
              </div>
              <div class="ohlc-item">
                <span class="ohlc-label">C</span>
                <span class="ohlc-value" id="ohlcClose">-</span>
              </div>
            </div>

            <div class="indicators-panel" id="indicatorsPanel">
            </div>

            <div id="main-chart"></div>
          </div>
          <div id="equity-chart"></div>
        </div>

        <!-- Strategy Panel -->
        <div class="strategy-panel" id="strategyPanel">
          <div class="panel-header">
            <span class="panel-title">
              <svg viewBox="0 0 24 24" fill="currentColor">
                <path
                  d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zM9 17H7v-7h2v7zm4 0h-2V7h2v10zm4 0h-2v-4h2v4z" />
              </svg>
              Strategy Tester
            </span>
          </div>

          <div class="panel-tabs">
            <button class="panel-tab active" data-tab="settings">Settings</button>
            <button class="panel-tab" data-tab="finder">Finder</button>
            <button class="panel-tab" data-tab="walkforward">Walk-Forward</button>
            <button class="panel-tab" data-tab="results">Results</button>
            <button class="panel-tab" data-tab="trades">Trades</button>
          </div>

          <div class="panel-content" id="panelContent">
            <!-- Settings Tab -->
            <div id="settingsTab">
              <select class="strategy-select" id="strategySelect">
                <option value="sma_crossover">SMA Crossover</option>
                <option value="ema_crossover">EMA Crossover</option>
                <option value="rsi_oversold">RSI Overbought/Oversold</option>
                <option value="macd_crossover">MACD Crossover</option>
                <option value="bollinger_bounce">Bollinger Band Bounce</option>
                <option value="triple_ma">Triple MA Strategy</option>
              </select>

              <div id="strategyParams">
                <!-- Parameters will be injected here -->
              </div>

              <div class="section-header">
                <div class="section-title">Fixed Trade Amount Mode</div>
                <label class="section-toggle" aria-label="Toggle fixed trade amount mode">
                  <input type="checkbox" id="fixedTradeToggle" checked>
                  <span class="section-toggle-track"></span>
                </label>
              </div>
              <div class="section-body" id="tradeSizing">
                <div class="param-row">
                  <div class="param-group" id="initialCapitalGroup">
                    <label class="param-label">Initial Capital ($)</label>
                    <input type="number" class="param-input" id="initialCapital" value="10000" min="100">
                  </div>
                  <div class="param-group" id="fixedTradeGroup">
                    <label class="param-label">Fixed Trade Amount ($)</label>
                    <input type="number" class="param-input" id="fixedTradeAmount" value="1000" min="1">
                  </div>
                </div>

                <div class="param-row">
                  <div class="param-group" id="positionSizeGroup">
                    <label class="param-label">Position Size (%)</label>
                    <input type="number" class="param-input" id="positionSize" value="100" min="1" max="100">
                  </div>
                  <div class="param-group">
                    <label class="param-label">Commission (%)</label>
                    <input type="number" class="param-input" id="commission" value="0.1" min="0" step="0.01">
                  </div>
                </div>
              </div>

              <div class="section-header">
                <div class="section-title">Short Mode</div>
                <label class="section-toggle" aria-label="Toggle short mode">
                  <input type="checkbox" id="shortModeToggle" checked>
                  <span class="section-toggle-track"></span>
                </label>
              </div>

              <div class="section-header">
                <div class="section-title">Risk Management</div>
                <label class="section-toggle" aria-label="Toggle risk management">
                  <input type="checkbox" id="riskSettingsToggle">
                  <span class="section-toggle-track"></span>
                </label>
              </div>
              <div class="section-body" id="riskSettings">
                <div class="param-row">
                  <div class="param-group">
                    <label class="param-label">Mode</label>
                    <select class="param-input" id="riskMode">
                      <option value="simple" selected>Simple</option>
                      <option value="advanced">Advanced</option>
                    </select>
                    <div class="param-hint">Simple shows core stops. Advanced adds scale-out, break-even, and time stop.
                    </div>
                  </div>
                </div>
                <div class="param-row">
                  <div class="param-group">
                    <label class="param-label">Volatility Period (ATR)</label>
                    <input type="number" class="param-input" id="atrPeriod" value="14" min="1">
                    <div class="param-hint">ATR measures average movement. Higher = smoother stops.</div>
                  </div>
                  <div class="param-group">
                    <label class="param-label">Stop Loss (ATR x)</label>
                    <input type="number" class="param-input" id="stopLossAtr" value="1.5" min="0" step="0.1">
                  </div>
                </div>
                <div class="param-row">
                  <div class="param-group">
                    <label class="param-label">Take Profit (ATR x)</label>
                    <input type="number" class="param-input" id="takeProfitAtr" value="3" min="0" step="0.1">
                  </div>
                  <div class="param-group">
                    <label class="param-label">Trailing Stop (ATR x)</label>
                    <input type="number" class="param-input" id="trailingAtr" value="2" min="0" step="0.1">
                  </div>
                </div>
                <div class="risk-advanced is-hidden" id="riskAdvanced">
                  <div class="param-row">
                    <div class="param-group">
                      <label class="param-label">Scale Out at R</label>
                      <input type="number" class="param-input" id="partialTakeProfitAtR" value="1" min="0" step="0.1">
                      <div class="param-hint">R = distance from entry to stop loss.</div>
                    </div>
                    <div class="param-group">
                      <label class="param-label">Scale Out Size (%)</label>
                      <input type="number" class="param-input" id="partialTakeProfitPercent" value="50" min="0"
                        max="100">
                    </div>
                  </div>
                  <div class="param-row">
                    <div class="param-group">
                      <label class="param-label">Move Stop to Break-even at R</label>
                      <input type="number" class="param-input" id="breakEvenAtR" value="1" min="0" step="0.1">
                    </div>
                    <div class="param-group">
                      <label class="param-label">Exit After N Bars (if losing)</label>
                      <input type="number" class="param-input" id="timeStopBars" value="0" min="0">
                    </div>
                  </div>
                </div>
              </div>

              <div class="section-header">
                <div class="section-title">Regime Filters</div>
                <label class="section-toggle" aria-label="Toggle regime filters">
                  <input type="checkbox" id="regimeSettingsToggle">
                  <span class="section-toggle-track"></span>
                </label>
              </div>
              <div class="section-body" id="regimeSettings">
                <div class="param-row">
                  <div class="param-group">
                    <label class="param-label">Trend EMA Period</label>
                    <input type="number" class="param-input" id="trendEmaPeriod" value="200" min="0">
                  </div>
                  <div class="param-group">
                    <label class="param-label">EMA Slope Bars</label>
                    <input type="number" class="param-input" id="trendEmaSlopeBars" value="0" min="0">
                  </div>
                </div>
                <div class="param-row">
                  <div class="param-group">
                    <label class="param-label">ATR% Min</label>
                    <input type="number" class="param-input" id="atrPercentMin" value="0" min="0" step="0.1">
                  </div>
                  <div class="param-group">
                    <label class="param-label">ATR% Max</label>
                    <input type="number" class="param-input" id="atrPercentMax" value="0" min="0" step="0.1">
                  </div>
                </div>
                <div class="param-row">
                  <div class="param-group">
                    <label class="param-label">ADX Period</label>
                    <input type="number" class="param-input" id="adxPeriod" value="14" min="0">
                  </div>
                  <div class="param-group">
                    <label class="param-label">ADX Min</label>
                    <input type="number" class="param-input" id="adxMin" value="0" min="0" step="0.1">
                  </div>
                </div>
                <div class="param-row">
                  <div class="param-group">
                    <label class="param-label">ADX Max</label>
                    <input type="number" class="param-input" id="adxMax" value="0" min="0" step="0.1">
                  </div>
                </div>
              </div>

              <div class="section-header">
                <div class="section-title">Entry Confirmation</div>
                <label class="section-toggle" aria-label="Toggle entry confirmation">
                  <input type="checkbox" id="entrySettingsToggle">
                  <span class="section-toggle-track"></span>
                </label>
              </div>
              <div class="section-body" id="entrySettings">
                <div class="param-group">
                  <label class="param-label">Confirmation Mode</label>
                  <select class="param-input" id="entryConfirmation">
                    <option value="none" selected>None</option>
                    <option value="close">Close Breakout</option>
                    <option value="volume">Volume Expansion</option>
                    <option value="rsi">RSI Confirmation</option>
                  </select>
                </div>
                <div class="param-row">
                  <div class="param-group">
                    <label class="param-label">Confirm Lookback (bars)</label>
                    <input type="number" class="param-input" id="confirmLookback" value="1" min="1">
                  </div>
                  <div class="param-group">
                    <label class="param-label">Volume SMA Period</label>
                    <input type="number" class="param-input" id="volumeSmaPeriod" value="20" min="1">
                  </div>
                </div>
                <div class="param-row">
                  <div class="param-group">
                    <label class="param-label">Volume Multiplier</label>
                    <input type="number" class="param-input" id="volumeMultiplier" value="1.5" min="0" step="0.1">
                  </div>
                  <div class="param-group">
                    <label class="param-label">RSI Period</label>
                    <input type="number" class="param-input" id="confirmRsiPeriod" value="14" min="1">
                  </div>
                </div>
                <div class="param-row">
                  <div class="param-group">
                    <label class="param-label">RSI Bullish</label>
                    <input type="number" class="param-input" id="confirmRsiBullish" value="55" min="0" max="100">
                  </div>
                  <div class="param-group">
                    <label class="param-label">RSI Bearish</label>
                    <input type="number" class="param-input" id="confirmRsiBearish" value="45" min="0" max="100">
                  </div>
                </div>
              </div>

              <button class="btn btn-primary run-btn" id="runBacktest">
                <svg viewBox="0 0 24 24" fill="currentColor">
                  <path d="M8 5v14l11-7z" />
                </svg>
                Run Backtest
              </button>

              <div class="progress-container" id="progressContainer">
                <div class="progress-bar">
                  <div class="progress-fill" id="progressFill"></div>
                </div>
                <div class="progress-text" id="progressText">Processing...</div>
              </div>

              <!-- Settings Actions -->
              <div class="settings-actions">
                <div class="settings-actions-row">
                  <button class="btn btn-secondary btn-compact" id="resetSettingsBtn"
                    title="Reset all settings to default values">
                    <svg viewBox="0 0 24 24" fill="currentColor" width="14" height="14">
                      <path
                        d="M12 5V1L7 6l5 5V7c3.31 0 6 2.69 6 6s-2.69 6-6 6-6-2.69-6-6H4c0 4.42 3.58 8 8 8s8-3.58 8-8-3.58-8-8-8z" />
                    </svg>
                    Reset to Default
                  </button>
                </div>

                <div class="section-header config-header">
                  <div class="section-title">Strategy Configurations</div>
                </div>

                <div class="config-actions">
                  <div class="config-input-row">
                    <input type="text" class="param-input config-name-input" id="configNameInput"
                      placeholder="Configuration name..." />
                    <button class="btn btn-success btn-icon" id="saveConfigBtn"
                      title="Save current settings as configuration">
                      <svg viewBox="0 0 24 24" fill="currentColor" width="16" height="16">
                        <path
                          d="M17 3H5c-1.11 0-2 .9-2 2v14c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2V7l-4-4zm2 16H5V5h11.17L19 7.83V19zm-7-7c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3zM6 6h9v4H6V6z" />
                      </svg>
                    </button>
                  </div>

                  <div class="config-list-wrapper">
                    <select class="param-input config-select" id="configSelect">
                      <option value="">-- Select configuration --</option>
                    </select>
                    <button class="btn btn-primary btn-icon" id="loadConfigBtn" title="Load selected configuration">
                      <svg viewBox="0 0 24 24" fill="currentColor" width="16" height="16">
                        <path d="M19 9h-4V3H9v6H5l7 7 7-7zM5 18v2h14v-2H5z" />
                      </svg>
                    </button>
                    <button class="btn btn-danger btn-icon" id="deleteConfigBtn" title="Delete selected configuration">
                      <svg viewBox="0 0 24 24" fill="currentColor" width="16" height="16">
                        <path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z" />
                      </svg>
                    </button>
                  </div>
                </div>
              </div>

              <button class="open-editor-btn" id="openCodeEditor">
                <svg viewBox="0 0 24 24" fill="currentColor">
                  <path
                    d="M9.4 16.6L4.8 12l4.6-4.6L8 6l-6 6 6 6 1.4-1.4zm5.2 0l4.6-4.6-4.6-4.6L16 6l6 6-6 6-1.4-1.4z" />
                </svg>
                Create Custom Strategy
              </button>
            </div>

            <!-- Finder Tab -->
            <div id="finderTab">
              <div class="section-title">Strategy Finder</div>

              <div class="param-group">
                <label class="param-label">Sort By</label>
                <select class="param-input" id="finderSort">
                  <option value="netProfit" selected>Net Profit</option>
                  <option value="profitFactor">Profit Factor</option>
                  <option value="sharpeRatio">Sharpe Ratio</option>
                  <option value="netProfitPercent">Net Profit %</option>
                  <option value="winRate">Win Rate</option>
                  <option value="maxDrawdownPercent">Max Drawdown %</option>
                </select>
              </div>

              <div class="param-row">
                <div class="param-group">
                  <label class="param-label">Top Results</label>
                  <input type="number" class="param-input" id="finderTopN" value="10" min="1" max="100">
                </div>
                <div class="param-group">
                  <label class="param-label">Runs / Strategy</label>
                  <input type="number" class="param-input" id="finderMaxRuns" value="50" min="1" max="500">
                </div>
              </div>

              <div class="param-row">
                <div class="param-group">
                  <label class="param-label">Search Mode</label>
                  <select class="param-input" id="finderMode">
                    <option value="default" selected>Defaults Only</option>
                    <option value="grid">Grid Sweep</option>
                    <option value="random">Random Search</option>
                  </select>
                </div>
                <div class="param-group">
                  <label class="param-label">Range (%)</label>
                  <input type="number" class="param-input" id="finderRange" value="50" min="0" max="300" step="5">
                </div>
              </div>

              <div class="param-row">
                <div class="param-group">
                  <label class="param-label">Steps / Param</label>
                  <input type="number" class="param-input" id="finderSteps" value="3" min="2" max="7">
                </div>
              </div>

              <div class="section-header">
                <div class="section-title">Strategies</div>
                <label class="section-toggle" aria-label="Toggle all strategies">
                  <input type="checkbox" id="finderStrategiesToggleAll" checked>
                  <span class="section-toggle-track"></span>
                </label>
              </div>
              <div class="section-body strategy-list-container" id="finderStrategyList">
                <!-- Strategies will be injected here -->
              </div>

              <div class="section-header">

                <div class="section-title">Trade Count Filter</div>
                <label class="section-toggle" aria-label="Toggle trade count filter">
                  <input type="checkbox" id="finderTradesToggle">
                  <span class="section-toggle-track"></span>
                </label>
              </div>
              <div class="section-body" id="finderTradeFilters">
                <div class="param-row">
                  <div class="param-group">
                    <label class="param-label">Min Trades</label>
                    <input type="number" class="param-input" id="finderTradesMin" value="0" min="0">
                  </div>
                  <div class="param-group">
                    <label class="param-label">Max Trades</label>
                    <input type="number" class="param-input" id="finderTradesMax" placeholder="No max" min="0">
                  </div>
                </div>
              </div>

              <button class="btn btn-primary run-btn" id="runFinder">
                <svg viewBox="0 0 24 24" fill="currentColor">
                  <path d="M8 5v14l11-7z" />
                </svg>
                Run Finder
              </button>

              <div class="progress-container" id="finderProgress">
                <div class="progress-bar">
                  <div class="progress-fill" id="finderProgressFill"></div>
                </div>
                <div class="progress-text" id="finderProgressText">Ready</div>
              </div>

              <div class="finder-status" id="finderStatus">Idle</div>

              <div class="finder-results">
                <div class="finder-header">
                  <span>Rank</span>
                  <span>Strategy</span>
                  <span>Use</span>
                </div>
                <div class="empty-state" id="finderEmpty">
                  <svg viewBox="0 0 24 24" fill="currentColor">
                    <path d="M3 3h18v2H3V3zm0 16h18v2H3v-2zm0-8h18v2H3v-2zm0-4h18v2H3V7z" />
                  </svg>
                  <h3>No Finder Results</h3>
                  <p>Run the finder to rank strategies</p>
                </div>
                <div class="finder-list" id="finderList">
                </div>
              </div>
            </div>

            <!-- Walk-Forward Tab -->
            <div id="walkforwardTab">
              <div class="section-title">Walk-Forward Analysis</div>
              <p class="section-desc">Test strategy robustness by optimizing on rolling windows and testing on
                out-of-sample data.</p>

              <div class="section-header">
                <div class="section-title">Window Settings</div>
              </div>
              <div class="section-body">
                <div class="param-row">
                  <div class="param-group">
                    <label class="param-label">Optimization Window (bars)</label>
                    <input type="number" class="param-input" id="wf-opt-window" value="200" min="50">
                    <div class="param-hint">In-sample period for parameter optimization</div>
                  </div>
                  <div class="param-group">
                    <label class="param-label">Test Window (bars)</label>
                    <input type="number" class="param-input" id="wf-test-window" value="50" min="10">
                    <div class="param-hint">Out-of-sample period to validate performance</div>
                  </div>
                </div>
                <div class="param-row">
                  <div class="param-group">
                    <label class="param-label">Step Size (bars)</label>
                    <input type="number" class="param-input" id="wf-step-size" value="50" min="10">
                    <div class="param-hint">How far to advance between windows (= test window for non-overlap)</div>
                  </div>
                  <div class="param-group">
                    <label class="param-label">Min Trades</label>
                    <input type="number" class="param-input" id="wf-min-trades" value="5" min="1">
                  </div>
                </div>
                <div class="param-row">
                  <div class="param-group">
                    <label class="param-label">Top N (avg params)</label>
                    <input type="number" class="param-input" id="wf-top-n" value="3" min="1" max="10">
                    <div class="param-hint">Average top N parameter sets for robustness</div>
                  </div>
                </div>
              </div>

              <div class="wf-actions">
                <button class="btn btn-primary run-btn" id="wf-run-btn">
                  <svg viewBox="0 0 24 24" fill="currentColor">
                    <path d="M8 5v14l11-7z" />
                  </svg>
                  Run Walk-Forward
                  <span class="spinner" id="wf-spinner" style="display:none;"></span>
                </button>
                <button class="btn btn-secondary" id="wf-quick-btn">
                  Quick Analysis
                </button>
              </div>

              <div class="wf-status-bar">
                <span id="wf-status">Ready</span>
              </div>

              <!-- Robustness Gauge -->
              <div class="wf-robustness">
                <div class="wf-gauge" id="wf-robustness-gauge">
                  <div class="wf-gauge-fill"></div>
                  <div class="wf-gauge-label">
                    <span class="wf-gauge-score" id="wf-robustness-score">--</span>
                    <span class="wf-gauge-max">/100</span>
                  </div>
                </div>
                <div class="wf-robustness-title">Robustness Score</div>
                <div class="wf-robustness-desc" id="wf-robustness-desc">Run analysis to see robustness score</div>
              </div>

              <!-- Summary Stats -->
              <div class="wf-summary" id="wf-summary-panel">
                <div class="empty-state">
                  <p>Run walk-forward analysis to see results</p>
                </div>
              </div>

              <!-- Window Breakdown Table -->
              <div class="section-header">
                <div class="section-title">Window Breakdown</div>
              </div>
              <div class="wf-table-wrapper">
                <table class="wf-table">
                  <thead>
                    <tr>
                      <th>#</th>
                      <th>IS %</th>
                      <th>OOS %</th>
                      <th>Deg %</th>
                      <th>IS SR</th>
                      <th>OOS SR</th>
                      <th>Params</th>
                      <th>âœ“</th>
                    </tr>
                  </thead>
                  <tbody id="wf-window-table-body">
                    <tr>
                      <td colspan="8" class="empty-cell">No data</td>
                    </tr>
                  </tbody>
                </table>
              </div>
            </div>

            <!-- Results Tab -->
            <div id="resultsTab">
              <div class="empty-state" id="emptyResults">
                <svg viewBox="0 0 24 24" fill="currentColor">
                  <path
                    d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zM9 17H7v-7h2v7zm4 0h-2V7h2v10zm4 0h-2v-4h2v4z" />
                </svg>
                <h3>No Results Yet</h3>
                <p>Run a backtest to see performance results</p>
              </div>
              <div id="resultsContent">
                <div class="stats-grid">
                  <div class="stat-card" id="netProfitCard">
                    <div class="stat-label">Net Profit</div>
                    <div class="stat-value" id="netProfit">$0.00</div>
                  </div>
                  <div class="stat-card" id="netProfitPctCard">
                    <div class="stat-label">Net Profit %</div>
                    <div class="stat-value" id="netProfitPct">0.00%</div>
                  </div>
                  <div class="stat-card">
                    <div class="stat-label">Expectancy</div>
                    <div class="stat-value" id="expectancy">$0.00</div>
                  </div>
                  <div class="stat-card">
                    <div class="stat-label">Avg Trade</div>
                    <div class="stat-value" id="avgTrade">$0.00</div>
                  </div>
                  <div class="stat-card">
                    <div class="stat-label">Win Rate</div>
                    <div class="stat-value" id="winRate">0%</div>
                  </div>
                  <div class="stat-card">
                    <div class="stat-label">Profit Factor</div>
                    <div class="stat-value" id="profitFactor">0.00</div>
                  </div>
                  <div class="stat-card">
                    <div class="stat-label">Total Trades</div>
                    <div class="stat-value" id="totalTrades">0</div>
                  </div>
                  <div class="stat-card">
                    <div class="stat-label">Max Drawdown</div>
                    <div class="stat-value negative" id="maxDrawdown">0%</div>
                  </div>
                  <div class="stat-card">
                    <div class="stat-label">Winning Trades</div>
                    <div class="stat-value positive" id="winningTrades">0</div>
                  </div>
                  <div class="stat-card">
                    <div class="stat-label">Losing Trades</div>
                    <div class="stat-value negative" id="losingTrades">0</div>
                  </div>
                  <div class="stat-card">
                    <div class="stat-label">Avg Win</div>
                    <div class="stat-value positive" id="avgWin">$0.00</div>
                  </div>
                  <div class="stat-card">
                    <div class="stat-label">Avg Loss</div>
                    <div class="stat-value negative" id="avgLoss">$0.00</div>
                  </div>
                  <div class="stat-card full-width">
                    <div class="stat-label">Sharpe Ratio</div>
                    <div class="stat-value" id="sharpeRatio">0.00</div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Trades Tab -->
            <div id="tradesTab">
              <div class="empty-state" id="emptyTrades">
                <svg viewBox="0 0 24 24" fill="currentColor">
                  <path d="M3 13h2v-2H3v2zm0 4h2v-2H3v2zm0-8h2V7H3v2zm4 4h14v-2H7v2zm0 4h14v-2H7v2zM7 7v2h14V7H7z" />
                </svg>
                <h3>No Trades</h3>
                <p>Run a backtest to see trade history</p>
              </div>
              <div class="trades-list" id="tradesList">
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Status Bar -->
    <div class="status-bar">
      <div class="status-left">
        <div class="status-item">
          <span class="status-dot"></span>
          <span>Live</span>
        </div>
        <span id="lastUpdate">Last update: -</span>
      </div>
      <div class="status-right">
        <span id="strategyStatus">Ready</span>
        <span>|</span>
        <span id="dataPoints">0 candles</span>
        <button class="debug-toggle" id="debugToggle" type="button" aria-pressed="false">Debug</button>
      </div>
    </div>
  </div>

  <div class="debug-panel" id="debugPanel" aria-hidden="true">
    <div class="debug-header">
      <div class="debug-title">Debug Console</div>
      <div class="debug-actions">
        <button class="debug-btn" id="debugCopy" type="button">Copy</button>
        <button class="debug-btn" id="debugClear" type="button">Clear</button>
        <button class="debug-btn" id="debugClose" type="button">Close</button>
      </div>
    </div>
    <div class="debug-body">
      <div class="debug-section">
        <div class="debug-label">State</div>
        <pre class="debug-pre" id="debugState">Loading...</pre>
      </div>
      <div class="debug-section">
        <div class="debug-label">Perf</div>
        <pre class="debug-pre" id="debugPerf">Loading...</pre>
      </div>
      <div class="debug-section">
        <div class="debug-label">Logs</div>
        <div class="debug-log" id="debugLogList"></div>
      </div>
    </div>
  </div>

  <!-- Code Editor Modal -->
  <div class="modal-overlay" id="codeEditorModal">
    <div class="modal code-editor-modal">
      <div class="modal-header">
        <span class="modal-title">Strategy Code Editor</span>
        <button class="modal-close" id="closeCodeEditor">
          <svg viewBox="0 0 24 24" fill="currentColor" width="18" height="18">
            <path
              d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z" />
          </svg>
        </button>
      </div>
      <div class="modal-body">
        <div class="editor-sidebar">
          <div class="sidebar-section">
            <div class="sidebar-title">Saved Presets</div>
            <button class="btn btn-secondary btn-block btn-compact" id="newPresetBtn">
              <svg viewBox="0 0 24 24" fill="currentColor" width="14" height="14">
                <path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z" />
              </svg>
              New Strategy
            </button>
          </div>
          <div class="preset-list" id="presetList">
            <!-- Presets will be injected here -->
          </div>
          <div class="sidebar-section editor-help">
            <h4>Available Indicators</h4>
            <p><code>indicators.calculateSMA(data, period)</code></p>
            <p><code>indicators.calculateEMA(data, period)</code></p>
            <p><code>indicators.calculateRSI(data, period)</code></p>
            <p><code>indicators.calculateMACD(data, fast, slow, signal)</code></p>
            <p><code>indicators.calculateBollingerBands(data, period, stdDev)</code></p>
            <p><code>indicators.calculateStochastic(high, low, close, kPeriod, dPeriod)</code></p>
            <p><code>indicators.calculateVWAP(ohlcv)</code></p>
            <p><code>indicators.calculateATR(high, low, close, period)</code></p>
            <p><code>indicators.calculateADX(high, low, close, period)</code></p>
            <p><code>indicators.calculateVolumeProfile(data, period, bins)</code></p>
            <h4>Data Structure</h4>
            <p><code>data[i].time</code> - Timestamp</p>
            <p><code>data[i].open/high/low/close</code></p>
            <p><code>data[i].volume</code></p>
            <h4>Return Format</h4>
            <p>Return array of <code>{time, type: 'buy'|'sell', price, reason}</code></p>
          </div>
        </div>
        <div class="editor-main">
          <div class="editor-toolbar">
            <div class="editor-input-group">
              <label>Strategy Name</label>
              <input type="text" id="strategyName" placeholder="My Custom Strategy" />
            </div>
            <div class="editor-input-group">
              <label>Strategy Key</label>
              <input type="text" id="strategyKey" placeholder="my_custom_strategy" />
            </div>
            <div class="editor-spacer"></div>
            <button class="btn btn-secondary" id="validateCodeBtn">
              <svg viewBox="0 0 24 24" fill="currentColor" width="14" height="14">
                <path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z" />
              </svg>
              Validate
            </button>
          </div>
          <div id="monaco-container"></div>
          <div class="editor-footer">
            <div class="editor-status" id="editorStatus">
              Ready to code
            </div>
            <div class="editor-actions">
              <button class="btn btn-secondary" id="savePresetBtn">
                <svg viewBox="0 0 24 24" fill="currentColor" width="14" height="14">
                  <path
                    d="M17 3H5c-1.11 0-2 .9-2 2v14c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2V7l-4-4zm2 16H5V5h11.17L19 7.83V19zm-7-7c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3zM6 6h9v4H6V6z" />
                </svg>
                Save Preset
              </button>
              <button class="btn btn-success" id="applyStrategyBtn">
                <svg viewBox="0 0 24 24" fill="currentColor" width="14" height="14">
                  <path d="M8 5v14l11-7z" />
                </svg>
                Apply & Run
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script type="module" src="index.ts"></script>
</body>

</html>