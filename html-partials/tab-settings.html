<!-- Settings Tab -->
<div id="settingsTab">
    <select class="strategy-select" id="strategySelect">
        <option value="sma_crossover">SMA Crossover</option>
        <option value="ema_crossover">EMA Crossover</option>
        <option value="rsi_oversold">RSI Overbought/Oversold</option>
        <option value="macd_crossover">MACD Crossover</option>
        <option value="bollinger_bounce">Bollinger Band Bounce</option>
        <option value="triple_ma">Triple MA Strategy</option>
    </select>

    <div id="strategyParams">
        <!-- Parameters will be injected here -->
    </div>

    <div class="section-header">
        <div class="section-title">Backend Engine</div>
        <label class="section-toggle" aria-label="Toggle Rust backend">
            <input type="checkbox" id="useRustEngineToggle" checked>
            <span class="section-toggle-track"></span>
        </label>
    </div>
    <div class="param-hint">Prefer Rust for faster backtests when available. Turn off to force TypeScript.</div>

    <div class="section-header">
        <div class="section-title">Backtest Realism</div>
    </div>
    <div class="section-body">
        <div class="param-row">
            <div class="param-group">
                <label class="param-label">Execution Model</label>
                <select class="param-input" id="executionModel">
                    <option value="next_open" selected>Next Bar Open (realistic)</option>
                    <option value="next_close">Next Bar Close (conservative)</option>
                    <option value="signal_close">Signal Bar Close (optimistic)</option>
                </select>
                <div class="param-hint">Next-bar execution reduces look-ahead bias.</div>
            </div>
            <div class="param-group">
                <label class="param-label">Slippage (bps)</label>
                <input type="number" class="param-input" id="slippageBps" value="5" min="0" max="100" step="1">
                <div class="param-hint">Applied on entry and exit fills.</div>
            </div>
        </div>
        <div class="param-row">
            <div class="param-group">
                <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 4px;">
                    <label class="param-label" style="margin-bottom: 0;">Allow Same-Bar Exits</label>
                    <label class="section-toggle" style="transform: scale(0.8);" aria-label="Toggle same-bar exits">
                        <input type="checkbox" id="allowSameBarExitToggle">
                        <span class="section-toggle-track"></span>
                    </label>
                </div>
                <div class="param-hint">Disable to avoid entry/exit on the same bar.</div>
            </div>
        </div>
        <div class="param-row">
            <div class="param-group">
                <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 4px;">
                    <label class="param-label" style="margin-bottom: 0;">Use Strategy Timeframe</label>
                    <label class="section-toggle" style="transform: scale(0.8);" aria-label="Toggle global strategy timeframe">
                        <input type="checkbox" id="strategyTimeframeToggle">
                        <span class="section-toggle-track"></span>
                    </label>
                </div>
                <div class="param-hint">Run signal logic on higher timeframe, map entries back to current chart bars.</div>
            </div>
            <div class="param-group" id="strategyTimeframeMinutesGroup">
                <label class="param-label">Strategy TF (minutes)</label>
                <input type="number" class="param-input" id="strategyTimeframeMinutes" value="120" min="1" step="1">
                <div class="param-hint">Example: chart 5m + strategy 120m.</div>
            </div>
        </div>
        <div class="param-hint">Realism settings use the TypeScript engine (Rust skipped for accuracy).</div>
    </div>

    <div class="section-header">
        <div class="section-title">Fixed Trade Amount Mode</div>
        <label class="section-toggle" aria-label="Toggle fixed trade amount mode">
            <input type="checkbox" id="fixedTradeToggle" checked>
            <span class="section-toggle-track"></span>
        </label>
    </div>
    <div class="section-body" id="tradeSizing">
        <div class="param-row">
            <div class="param-group" id="initialCapitalGroup">
                <label class="param-label">Initial Capital ($)</label>
                <input type="number" class="param-input" id="initialCapital" value="10000" min="100">
            </div>
            <div class="param-group" id="fixedTradeGroup">
                <label class="param-label">Fixed Trade Amount ($)</label>
                <input type="number" class="param-input" id="fixedTradeAmount" value="1000" min="1">
            </div>
        </div>

        <div class="param-row">
            <div class="param-group" id="positionSizeGroup">
                <label class="param-label">Position Size (%)</label>
                <input type="number" class="param-input" id="positionSize" value="100" min="1" max="100">
            </div>
            <div class="param-group">
                <label class="param-label">Commission (%)</label>
                <input type="number" class="param-input" id="commission" value="0.1" min="0" step="0.01">
            </div>
        </div>
    </div>

    <div class="section-header">
        <div class="section-title">Trade Direction</div>
    </div>
    <div class="section-body">
        <div class="param-row">
            <div class="param-group">
                <label class="param-label">Direction Mode</label>
                <select class="param-input" id="tradeDirection">
                    <option value="long">Long</option>
                    <option value="short" selected>Short</option>
                    <option value="both">Both (Flip)</option>
                </select>
                <div class="param-hint">Both mode exits and reverses on opposite entry signals.</div>
            </div>
        </div>
    </div>

    <div class="section-header">
        <div class="section-title">Risk Management</div>
        <label class="section-toggle" aria-label="Toggle risk management">
            <input type="checkbox" id="riskSettingsToggle">
            <span class="section-toggle-track"></span>
        </label>
    </div>
    <div class="section-body" id="riskSettings">
        <div class="param-row">
            <div class="param-group">
                <label class="param-label">Mode</label>
                <select class="param-input" id="riskMode">
                    <option value="simple" selected>Simple</option>
                    <option value="advanced">Advanced</option>
                    <option value="percentage">Percentage</option>
                </select>
                <div class="param-hint">Simple shows core stops. Advanced adds scale-out, break-even, and time stop.
                    Percentage uses fixed % from entry.
                </div>
            </div>
            <div class="param-group">
                <label class="param-label">Market Mode</label>
                <select class="param-input" id="marketMode">
                    <option value="all" selected>All Markets</option>
                    <option value="uptrend">Uptrend</option>
                    <option value="downtrend">Downtrend</option>
                    <option value="sideway">Sideway / Range</option>
                </select>
                <div class="param-hint">Trade filter by market regime before opening positions.</div>
            </div>
        </div>
        <div class="risk-simple-advanced" id="riskSimpleAdvanced">
            <div class="param-row">
                <div class="param-group">
                    <label class="param-label">Volatility Period (ATR)</label>
                    <input type="number" class="param-input" id="atrPeriod" value="14" min="1">
                    <div class="param-hint">ATR measures average movement. Higher = smoother stops.</div>
                </div>
                <div class="param-group">
                    <label class="param-label">Stop Loss (ATR x)</label>
                    <input type="number" class="param-input" id="stopLossAtr" value="1.5" min="0" step="0.1">
                </div>
            </div>
            <div class="param-row">
                <div class="param-group">
                    <label class="param-label">Take Profit (ATR x)</label>
                    <input type="number" class="param-input" id="takeProfitAtr" value="3" min="0" step="0.1">
                </div>
                <div class="param-group">
                    <label class="param-label">Trailing Stop (ATR x)</label>
                    <input type="number" class="param-input" id="trailingAtr" value="2" min="0" step="0.1">
                </div>
            </div>
            <div class="risk-advanced is-hidden" id="riskAdvanced">
                <div class="param-row">
                    <div class="param-group">
                        <label class="param-label">Scale Out at R</label>
                        <input type="number" class="param-input" id="partialTakeProfitAtR" value="1" min="0" step="0.1">
                        <div class="param-hint">R = distance from entry to stop loss.</div>
                    </div>
                    <div class="param-group">
                        <label class="param-label">Scale Out Size (%)</label>
                        <input type="number" class="param-input" id="partialTakeProfitPercent" value="50" min="0"
                            max="100">
                    </div>
                </div>
                <div class="param-row">
                    <div class="param-group">
                        <label class="param-label">Move Stop to Break-even at R</label>
                        <input type="number" class="param-input" id="breakEvenAtR" value="1" min="0" step="0.1">
                    </div>
                    <div class="param-group">
                        <label class="param-label">Exit After N Bars (if losing)</label>
                        <input type="number" class="param-input" id="timeStopBars" value="0" min="0">
                    </div>
                </div>
            </div>
        </div>
        <div class="risk-percentage is-hidden" id="riskPercentage">
            <div class="param-row">
                <div class="param-group">
                    <div
                        style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 4px;">
                        <label class="param-label" style="margin-bottom: 0;">Stop Loss (%)</label>
                        <label class="section-toggle" style="transform: scale(0.8);" aria-label="Toggle stop loss">
                            <input type="checkbox" id="stopLossToggle">
                            <span class="section-toggle-track"></span>
                        </label>
                    </div>
                    <input type="number" class="param-input" id="stopLossPercent" value="5" min="0.1" max="15"
                        step="0.1">
                    <div class="param-hint">Allowed: 0 - 15%</div>
                </div>
                <div class="param-group">
                    <div
                        style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 4px;">
                        <label class="param-label" style="margin-bottom: 0;">Take Profit (%)</label>
                        <label class="section-toggle" style="transform: scale(0.8);" aria-label="Toggle take profit">
                            <input type="checkbox" id="takeProfitToggle">
                            <span class="section-toggle-track"></span>
                        </label>
                    </div>
                    <input type="number" class="param-input" id="takeProfitPercent" value="10" min="0.1" max="100"
                        step="0.1">
                    <div class="param-hint">Allowed: 0 - 100%</div>
                </div>
            </div>
        </div>
    </div>

    <div class="section-header">
        <div class="section-title">Webhook Alerts</div>
        <label class="section-toggle" aria-label="Toggle webhook alerts">
            <input type="checkbox" id="webhookEnabledToggle">
            <span class="section-toggle-track"></span>
        </label>
    </div>
    <div class="section-body" id="webhookSettings">
        <!-- Webhook Status -->
        <div class="webhook-status" id="webhookStatus">
            <span class="webhook-status-dot status-disabled" id="webhookStatusDot"></span>
            <span class="webhook-status-text" id="webhookStatusText">Webhook disabled</span>
            <span class="webhook-status-count" id="webhookStatusCount"></span>
        </div>

        <!-- Webhook URL -->
        <div class="param-group">
            <label class="param-label">Webhook URL</label>
            <div class="webhook-url-wrapper">
                <input type="url" class="param-input" id="webhookUrl"
                    placeholder="https://your-webhook-endpoint.com/signal">
                <span class="webhook-url-validation" id="webhookUrlValidation"></span>
            </div>
            <div class="webhook-hint">Enter the URL where signals will be sent via POST request</div>
        </div>

        <!-- Secret Key -->
        <div class="param-group">
            <label class="param-label">Secret Key (Optional)</label>
            <div class="webhook-secret-wrapper">
                <input type="password" class="param-input" id="webhookSecretKey"
                    placeholder="For HMAC-SHA256 payload signing">
                <button type="button" class="webhook-secret-toggle" id="webhookSecretToggle" title="Toggle visibility">
                    <svg viewBox="0 0 24 24" fill="currentColor" width="16" height="16">
                        <path
                            d="M12 4.5C7 4.5 2.73 7.61 1 12c1.73 4.39 6 7.5 11 7.5s9.27-3.11 11-7.5c-1.73-4.39-6-7.5-11-7.5zM12 17c-2.76 0-5-2.24-5-5s2.24-5 5-5 5 2.24 5 5-2.24 5-5 5zm0-8c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3z" />
                    </svg>
                </button>
            </div>
            <div class="webhook-hint">Used to sign payloads so your receiver can verify authenticity</div>
        </div>

        <!-- Event Types -->
        <div class="param-group">
            <label class="param-label">Send Webhook On</label>
            <div class="webhook-events">
                <label class="webhook-event-option">
                    <input type="checkbox" id="webhookSendOnSignal" checked>
                    <span class="event-label">Strategy Signals</span>
                </label>
                <label class="webhook-event-option">
                    <input type="checkbox" id="webhookSendOnTrade" checked>
                    <span class="event-label">Trade Entry/Exit</span>
                </label>
            </div>
        </div>

        <!-- Test Button and Stats Row -->
        <div class="webhook-actions-row">
            <button type="button" class="btn-test-webhook" id="webhookTestBtn" disabled>
                <svg viewBox="0 0 24 24" fill="currentColor" width="16" height="16">
                    <path
                        d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z" />
                </svg>
                Test Webhook
            </button>
            <button type="button" class="btn-clear-queue" id="webhookClearBtn" title="Clear pending queue">
                <svg viewBox="0 0 24 24" fill="currentColor" width="14" height="14">
                    <path
                        d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z" />
                </svg>
            </button>
        </div>

        <!-- Statistics Panel -->
        <div class="webhook-stats" id="webhookStats">
            <div class="webhook-stat">
                <span class="webhook-stat-value" id="webhookStatSent">0</span>
                <span class="webhook-stat-label">Sent</span>
            </div>
            <div class="webhook-stat">
                <span class="webhook-stat-value" id="webhookStatPending">0</span>
                <span class="webhook-stat-label">Pending</span>
            </div>
            <div class="webhook-stat webhook-stat-error">
                <span class="webhook-stat-value" id="webhookStatFailed">0</span>
                <span class="webhook-stat-label">Failed</span>
            </div>
        </div>

        <!-- Activity Log -->
        <div class="webhook-activity-section">
            <div class="webhook-activity-header">
                <span class="webhook-activity-title">Recent Activity</span>
                <button type="button" class="webhook-activity-clear" id="webhookActivityClearBtn"
                    title="Clear log">Clear</button>
            </div>
            <div class="webhook-activity" id="webhookActivity">
                <div class="webhook-activity-empty">No webhook activity yet</div>
            </div>
        </div>
    </div>

    <div class="section-header">
        <div class="section-title">Trade Filter</div>
        <label class="section-toggle" aria-label="Toggle trade filter">
            <input type="checkbox" id="tradeFilterSettingsToggle">
            <span class="section-toggle-track"></span>
        </label>
    </div>
    <div class="section-body" id="tradeFilterSettings">
        <div class="param-group">
            <label class="param-label">Filter Mode</label>
            <select class="param-input" id="tradeFilterMode">
                <option value="none" selected>None</option>
                <option value="close">Close Breakout</option>
                <option value="volume">Volume Expansion</option>
                <option value="rsi">RSI Confirmation</option>
                <option value="trend">Trend Alignment (EMA)</option>
                <option value="adx">ADX Strength</option>
            </select>
            <div class="param-hint">Simple trade-quality filter applied before opening positions.</div>
        </div>
        <div class="param-row">
            <div class="param-group">
                <label class="param-label">Filter Lookback (bars)</label>
                <input type="number" class="param-input" id="confirmLookback" value="1" min="1">
            </div>
            <div class="param-group">
                <label class="param-label">Volume SMA Period</label>
                <input type="number" class="param-input" id="volumeSmaPeriod" value="20" min="1">
            </div>
        </div>
        <div class="param-row">
            <div class="param-group">
                <label class="param-label">Volume Multiplier</label>
                <input type="number" class="param-input" id="volumeMultiplier" value="1.5" min="0" step="0.1">
            </div>
            <div class="param-group">
                <label class="param-label">RSI Period</label>
                <input type="number" class="param-input" id="confirmRsiPeriod" value="14" min="1">
            </div>
        </div>
        <div class="param-row">
            <div class="param-group">
                <label class="param-label">RSI Bullish</label>
                <input type="number" class="param-input" id="confirmRsiBullish" value="55" min="0" max="100">
            </div>
            <div class="param-group">
                <label class="param-label">RSI Bearish</label>
                <input type="number" class="param-input" id="confirmRsiBearish" value="45" min="0" max="100">
            </div>
        </div>
    </div>

    <div class="section-header">
        <div class="section-title">Confirmation Strategies</div>
        <label class="section-toggle" aria-label="Toggle confirmation strategies">
            <input type="checkbox" id="confirmationStrategiesToggle">
            <span class="section-toggle-track"></span>
        </label>
    </div>
    <div class="section-body" id="confirmationStrategies">
        <div class="param-hint">Require additional strategy signals to confirm entries (filters persist until flipped). Up to 5.</div>
        <div class="confirmation-strategy-list" id="confirmationStrategyList"></div>
        <div class="confirmation-actions">
            <button class="btn btn-secondary btn-compact" id="confirmationAddBtn" type="button">Add Strategy</button>
        </div>
    </div>


    <div class="progress-container" id="progressContainer">
        <div class="progress-bar">
            <div class="progress-fill" id="progressFill"></div>
        </div>
        <div class="progress-text" id="progressText">Processing...</div>
    </div>

    <!-- Settings Actions -->
    <div class="settings-actions">
        <div class="settings-actions-row">
            <button class="btn btn-secondary btn-compact" id="resetSettingsBtn"
                title="Reset all settings to default values">
                <svg viewBox="0 0 24 24" fill="currentColor" width="14" height="14">
                    <path
                        d="M12 5V1L7 6l5 5V7c3.31 0 6 2.69 6 6s-2.69 6-6 6-6-2.69-6-6H4c0 4.42 3.58 8 8 8s8-3.58 8-8-3.58-8-8-8z" />
                </svg>
                Reset to Default
            </button>
        </div>

        <div class="section-header config-header">
            <div class="section-title">Strategy Configurations</div>
        </div>

        <div class="config-actions">
            <div class="config-input-row">
                <input type="text" class="param-input config-name-input" id="configNameInput"
                    placeholder="Configuration name..." />
                <button class="btn btn-success btn-icon" id="saveConfigBtn"
                    title="Save current settings as configuration">
                    <svg viewBox="0 0 24 24" fill="currentColor" width="16" height="16">
                        <path
                            d="M17 3H5c-1.11 0-2 .9-2 2v14c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2V7l-4-4zm2 16H5V5h11.17L19 7.83V19zm-7-7c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3zM6 6h9v4H6V6z" />
                    </svg>
                </button>
            </div>

            <div class="config-list-wrapper">
                <select class="param-input config-select" id="configSelect">
                    <option value="">-- Select configuration --</option>
                </select>
                <button class="btn btn-primary btn-icon" id="loadConfigBtn" title="Load selected configuration">
                    <svg viewBox="0 0 24 24" fill="currentColor" width="16" height="16">
                        <path d="M19 9h-4V3H9v6H5l7 7 7-7zM5 18v2h14v-2H5z" />
                    </svg>
                </button>
                <button class="btn btn-danger btn-icon" id="deleteConfigBtn" title="Delete selected configuration">
                    <svg viewBox="0 0 24 24" fill="currentColor" width="16" height="16">
                    <path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z" />
                </svg>
            </button>
            </div>

            <div class="config-share-actions">
                <button class="btn btn-secondary btn-compact" id="generateShareLinkBtn"
                    title="Generate unique link for selected configuration">
                    Generate Share Link
                </button>
                <button class="btn btn-primary btn-compact" id="copyShareLinkBtn" disabled
                    title="Copy generated share link">
                    Copy Link
                </button>
            </div>

            <input type="text" class="param-input config-share-link-input" id="shareConfigLinkInput"
                placeholder="Generated share link will appear here" readonly />

            <div class="config-import-row">
                <input type="text" class="param-input config-share-import-input" id="shareConfigImportInput"
                    placeholder="Paste shared strategy link (or token)..." />
                <button class="btn btn-primary btn-icon" id="loadShareLinkBtn" title="Load shared configuration">
                    <svg viewBox="0 0 24 24" fill="currentColor" width="16" height="16">
                        <path d="M19 9h-4V3H9v6H5l7 7 7-7zM5 18v2h14v-2H5z" />
                    </svg>
                </button>
            </div>
        </div>
    </div>

    <button class="open-editor-btn" id="openCodeEditor">
        <svg viewBox="0 0 24 24" fill="currentColor">
            <path d="M9.4 16.6L4.8 12l4.6-4.6L8 6l-6 6 6 6 1.4-1.4zm5.2 0l4.6-4.6-4.6-4.6L16 6l6 6-6 6-1.4-1.4z" />
        </svg>
        Create Custom Strategy
    </button>
</div>
